## 支付宝与微信支付的技术对接

工作近3年，参与3个系统的支付对接，第一个用Ping++来对接支付宝与微信支付，后二个系统直接对接支付宝与微信支付，为啥后面不用Ping++，Ping++要收费了，而且深入了解，对接支付宝与微信支付并没有想象中那么复杂，也许是熟悉就不觉得复杂了。

总结下来2点：
1. 多看几次支付宝与微信支付的时序图，深刻理解流程
2. 对接无非做2个逻辑，发起支付请求接口与支付成功异步回调接口

当然这是简单的理解，还有其他流程，比如退款，查询，对账等，看懂时序图与多实践才是关键

支付宝时序图：

![](https://github.com/lyaohe/lyaohe-cv/raw/master/img/alipay.png)

微信的图比较大，就不放出来了


下面说说如何实现2个接口

### 1. 发起支付请求接口

梳理一下这个接口，还有一个隐性逻辑，需要先创建订单，再发起支付请求，我不建议做成一个接口，分开实现更灵活；产品设计也应该区分开，创建订单与去支付两个逻辑，有时候也需要去订单列表发起二次支付，也有时候用抵扣券免单了，根本不需要向支付宝或微信发起支付请求。

    #接口有
    1. createOrder
    2. PayOrderForAlipay
    3. PayOrderForWechat
    
createOrder接口实现：
数据插入一条订单数据，这个并难实现，值得要注意的是，通常要创建唯一的订单号，用于发起支付请求，第一反应用主键自增Id，感觉自增Id又太短太简单了，可以参考数据库笔记创建表模板，设置自增Id大一点的数字，但其实也并不好，测试环境与正式环境的Id还是会冲突，所以自增Id不提倡用唯一的订单号；

自增Id不行，难道要用uuid ？  
uuid太长了，微信支付要求不能超过32位；

**目前想到比较好的是**，用时间yyyyMMddHHmmss+id构成唯一的订单号，两者结合能很好避免，高并发时时间会重复，多环境下id会重复的问题，id可以先插入订单，返回id再拼接起来，更新到唯一订单号字段；若有强迫症，用另外一张表来做生成Id。

PayOrderForAlipay接口实现：
传入订单Id，订单信息查询出来，调用支付宝发起支付请求的接口，具体看支付宝文档，这个接口还区分PC、APP；  
调用PC端接口，直接跳转到支付宝网页，PC网页支付成功可以做同步回调；  
调用APP接口，返回支付宝字符串给APP，自行调起支付界面。

PayOrderForWechat接口实现：
传入订单Id，订单信息查询出来，调用微信发起支付请求的接口，具体看微信支付文档，微信支付也分PC、APP，微信支付PC接口用公众号申请，微信支付APP接口在微信开放平台申请，各自申请支付权限，各分配微信商户账号，申请也挺麻烦的。  
调用PC支付接口，返回 `wx://` 格式链接，这是微信的二维码链接，把链接返回前端，前端来生成二维码图片；  
调用APP支付接口，返回XML的字符串给APP，自行调起微信支付。


### 2. 支付成功异步回调接口
啥？异步回调接口？因为我们并不知道用户啥时候支付成功，没可能发起付款请求，一直等用户支付再返回结果，那是不可能的，所以付款成功响应需要做成异步，其实就是按着支付宝与微信的规范，做一个被他们调用的接口，收到他们的请求通知，订单支付成功了。

梳理一下需求，我依然把接口拆分一下，有支付宝回调接口，微信回调接口，订单付款成功的通用接口：

* 支付宝回调接口：按支付宝规范，接收请求数据，解析校验签名，支付宝sdk有提供方法，确保请求是可靠的，这一点也非常重要，校验正确，调用`订单付款成功的通用接口`，并返回success
* 微信回调接口：按微信支付规范，接收请求XML数据，解析校验签名，微信也有提供方法，校验正确，调用`订单付款成功的通用接口`，并返回成功的XML
* 订单付款成功的通用接口：支付成功往往不只是更新订单，通常还有一系列业务逻辑，比如推送消息给后台，发邮件等等，所以需要一个共用接口，以后还可能对接其他支付系统；值得注意的是，更新订单状态的同时，要记录支付平台的唯一Id，确保每一个成功支付的订单，有自家的订单号，也有支付平台的订单号，方便日好查账。

**还有一个值得值得考虑的问题：订单的业务场景需要限时支付，超时释放资源（库存），如何处理释放后，用户才支付成功的特殊情况？**

目前我的思考与做法：
支付宝与微信支付都提供关闭支付订单的接口，是不是超时先调用接口关闭订单？
但是调用支付平台的查询接口，关闭接口也会有延时，个人觉得最好的处理流程是，分2步：
1. 先更新订单状态为超时无支付，再调用平台接口，查询并关闭订单，如果业务量不大，关闭订单可以先不做；
2. 付款成功的回调接口，更新订单前，要先检查订单是否超时，超时又支付成功更新为超时支付成功状态，后台审核后退款给用户更合理



能对接好支付功能，查询订单和退款对接，也不成问题的，加油！嘻嘻~

