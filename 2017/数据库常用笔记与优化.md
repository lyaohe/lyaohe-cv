## 数据库常用笔记与优化

平时笔记上记录的Sql零零散散，系统地整理一下常用Sql，省得每次百度查

[TOC]

#### 创建数据库
    -- 创建utf-8字符集数据库
    CREATE DATABASE db_name DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci;

#### 创建表模板

    CREATE TABLE `user` (
      `id` int(11) NOT NULL AUTO_INCREMENT,
      `username` varchar(255) NOT NULL DEFAULT '' COMMENT '用户名',
      `password` varchar(255)  NOT NULL DEFAULT '' COMMENT '密码',
      `status` smallint(6) NOT NULL DEFAULT '1' COMMENT '状态,0:禁用(disable),1:可用(available)',
      `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间', # Mysql5.6版本或以上才支持 CURRENT_TIMESTAMP
      `created_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
      PRIMARY KEY (`id`),
      UNIQUE KEY `username` (`username`)
    ) ENGINE=InnoDB AUTO_INCREMENT=10000 DEFAULT CHARSET=utf8;
    -- AUTO_INCREMENT不是必要的，有时候需要Id从某个数字开始，提供一个模板

    -- 新增字段
    ALTER TABLE h_order.t_appointment_time ADD COLUMN appointment_type tinyint (2) NOT NULL DEFAULT 3 COMMENT '排班类型,1:首诊(first_visit);2:复诊(return_visit);3:预约治疗(treat)' after appointment_end_time;

    -- 修改字段
    ALTER TABLE h_order.t_appointment_time CHANGE COLUMN appointment_type tinyint (2) NOT NULL DEFAULT 3 COMMENT '排班类型,1:首诊(first_visit);2:复诊(return_visit);3:预约治疗(treat)' after appointment_end_time;


说明:
* 默认要有id，created_at，created_at 基本字段
* 必须要有字段注释 COMMENT
* 枚举字段注释模板：状态,0:禁用(disable),1:可用(available)

#### 查看表结构\建表语句

    show create table table_name;

#### 插入数据

    -- 插入一条数据
    INSERT user SET
    username = 'user',
    password = md5('123456'),
    status = 1;

    -- 插入多条数据
    INSERT INTO user (username, password, status) values
    ('user1', md5(123456), 1),
    ('user2', md5(123456), 1),
    ('user3', md5(123456), 1);

### 删除数据

    -- 删除数据
    DELETE FROM table_name WHERE status = 0;

    -- 删除表中所有记录，谨慎使用
    TRUNCATE TABLE table_name;

### 更新数据

    UPDATE user SET status = '0' where id = 1;

    -- 复杂更新操作，比如新增计数字段，需要初始化
    update post p set p.comment_num = (select count(id) from comment c where c.post_id = c.id and c.status = 1)
    where p.type > 2;

### 事务操作

    -- 更新数据与删除数据，强烈建议开启事务
    begin
    -- 更新或删除数据
    -- 查询结果，检查操作是否达到预期
    commit #达到预期 commit
    rollback #操作失误 rollback


#### 查询优化